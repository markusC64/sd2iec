name: CI
on: 
   push:
      branches:
         - latest64k
         - testing*

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Build dist
      run: |
         sudo apt-get update
         sudo apt-get -y install avr-libc
         REV=$(git rev-parse --short HEAD | tr a-z A-Z)
         VER=63
         PLUS=+
         make CONFIG=configs/config-uIEC PRERELEASE=ATENTDEAD0-${VER}${PLUS}-$REV
         make CONFIG=configs/config-uIEC3 PRERELEASE=ATENTDEAD0-${VER}${PLUS}-$REV
         make CONFIG=configs/config-larsp PRERELEASE=ATENTDEAD0-${VER}${PLUS}-$REV
         make CONFIG=configs/config-sw1 PRERELEASE=ATENTDEAD0-${VER}${PLUS}-$REV
         make CONFIG=configs/config-sw2 PRERELEASE=ATENTDEAD0-${VER}${PLUS}-$REV
         make CONFIG="configs/config-larsp configs/addconfig-64k" PRERELEASE=ATENTDEAD0-${VER}${PLUS}-$REV
         make CONFIG="configs/config-sw1 configs/addconfig-64k" PRERELEASE=ATENTDEAD0-${VER}${PLUS}-$REV
         make CONFIG="configs/config-sw2 configs/addconfig-64k" PRERELEASE=ATENTDEAD0-${VER}${PLUS}-$REV
         mkdir bin
         cp obj-m1281-uIEC/sd2iec.bin bin/sd2iec-1.0.0atentdead0-${VER}${PLUS}-$REV-m1281-uIEC.bin
         cp obj-m1281-uIEC3/sd2iec.bin bin/sd2iec-1.0.0atentdead0-${VER}${PLUS}-$REV-m1281-uIEC3.bin
         cp obj-m1284p-larsp/sd2iec.bin bin/sd2iec-1.0.0atentdead0-${VER}${PLUS}-$REV-m1284p-larsp.bin
         cp obj-m1284p-sw1/sd2iec.bin bin/sd2iec-1.0.0atentdead0-${VER}${PLUS}-$REV-m1284p-sw1.bin
         cp obj-m1284p-sw2/sd2iec.bin bin/sd2iec-1.0.0atentdead0-${VER}${PLUS}-$REV-m1284p-sw2.bin
         cp obj-m644p-larsp-mini/sd2iec.bin bin/sd2iec-1.0.0atentdead0-${VER}${PLUS}-$REV-m644p-larsp.bin
         cp obj-m644p-larsp-mini/sd2iec.hex bin/sd2iec-1.0.0atentdead0-${VER}${PLUS}-$REV-m644p-larsp.hex
         cp obj-m644p-sw1-mini/sd2iec.bin bin/sd2iec-1.0.0atentdead0-${VER}${PLUS}-$REV-m644p-sw1.bin
         cp obj-m644p-sw2-mini/sd2iec.bin bin/sd2iec-1.0.0atentdead0-${VER}${PLUS}-$REV-m644p-sw2.bin

    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: sd2iec-firmware
        path: bin/
